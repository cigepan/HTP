<html>
<head>
  <title>Evernote Export</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/604085 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="855"/>

<div>
<span><div><div><br/></div><table style="border-collapse: collapse; min-width: 100%;"><colgroup><col style="width: 130px;"></col><col style="width: 130px;"></col><col style="width: 763px;"></col><col style="width: 130px;"></col></colgroup><tbody><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>功能块</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>HTP功能</div></td><td style="width: 763px; padding: 8px; border: 1px solid;"><div>功能说明</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>备注</div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>性能指标</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>单进程性能指标</div></td><td style="width: 763px; padding: 8px; border: 1px solid;"><ol><li><div>以下描述针对单个进程运行所对应的性能指标：<span style="color: rgb(227, 0, 0);">8核16线程3.7G睿频</span></div></li><li><div>所有影响性能的指标与CPU计数分布：行情清洗与存储80%,交易计划生成与执行以及相关交易数据存储%10，风控%5，日志记录%5（常开），定时触发的系统命令行进程：平均%10</div></li><li><div>开启所有功能：单个HTP进程占用CPU：2%以下，HTP进程内存占用：50M以内，MONGO服务CPU占用：%5以下</div></li><li><div>关闭行情存储（只交易但存储交易数据）：单个HTP进程占用CPU：0.5%以下，HTP进程内存占用：50M以内，MONGO服务CPU占用：%2以下</div></li><li><div>关闭交易与风控功能（只存储行情）：单个HTP进程占用CPU：2%以下，HTP进程内存占用：50M以内，MONGO服务CPU占用：%4以下</div></li><li><div>从行情TICK触发到生成订单再到调用下单接口过程经历的延迟：预估50us以内，主要跟CPU性能与过程执行的指令有关，主要涉及多线程间的MAP查找与相关变量修改判断，判断过程性能分布：行情TICK时间修正10%，获取解析后的TARGET%5，检查合约历史订单状态%10，检查获取持仓与扫描合约挂单（按平均每个合约两笔挂单计算）并计算持仓可用：%50，订单分割与生成（按单笔大单需拆分3次下单来计算）：10%，风控：%15</div></li><li><div>为了提高CPU利用率，将行情TICK与K线数据的存储改成队列定时100MS<span style="font-size: unset; color: unset; font-family: unset;">批量式刷写到MONGODB供盘后做数据分析，此操作</span><span style="font-size: unset; color: unset; font-family: unset;">不影响</span><span style="font-size: unset; color: unset; font-family: unset;">从TICK到触发交易整个过程，实时的最新行情存于内存MAP属于纳秒级延迟</span></div></li><li><div>优化后MAP效率：以存储2000个虚拟行情的KEY-MAP，KEY键值为8字节长的字符串为例：将最新的CTP原始行情行情TICK（约584字节）写到MAP中大约500<span style="color: rgb(227, 0, 0);">万</span>次大约用时<span style="color: rgb(227, 0, 0);">1500MS</span>，而传统字符串map则需要至少<span style="color: rgb(227, 0, 0);">7000MS</span></div></li></ol></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div><br/></div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>行情</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div><span style="font-size: 14px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(66, 66, 66); font-family: &quot;PingFang SC&quot;; font-variant-caps: normal; font-variant-ligatures: normal;">TICK行情处理</span></div></td><td style="width: 763px; padding: 8px; border: 1px solid;"><ol><li><div><span style="font-size: 14px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(66, 66, 66); font-family: &quot;PingFang SC&quot;; font-variant-caps: normal; font-variant-ligatures: normal;">采用环形队列方式缓存，约可容纳60S的缓存，占用一个处理线程用于存储MDB，100ms批量写入一次MDB</span></div></li><li><div><span style="font-size: 14px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(66, 66, 66); font-family: &quot;PingFang SC&quot;; font-variant-caps: normal; font-variant-ligatures: normal;">量差检测与时间修正成功后将立即被推送至交易线程队列与K线计算线程队列</span></div></li><li><div><span style="font-size: 14px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(66, 66, 66); font-family: &quot;PingFang SC&quot;; font-variant-caps: normal; font-variant-ligatures: normal;">进行量差检测，报错关键字：TV!</span></div></li><li><div><span style="font-size: 14px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(66, 66, 66); font-family: &quot;PingFang SC&quot;; font-variant-caps: normal; font-variant-ligatures: normal;">进行时间修正，报错关键字：TM!</span></div></li><li><div>对TICK进行时间过期修正，如果当前TICK时间对比网络时间跨度超过一个小时以上的则认定TICK超时，将不会被推送至交易线程和K线计算</div></li><li><div>针对TICK超时或量差异常的或修正时间失败的TICK将也会被保存到当前交易日的MDB中，但TradeDate字段为：-10101</div></li><li><div>行情的自然日修正来自于网络时间，如果网络时钟有4个NTP节点备选，如果网络时钟获取失败则程序异常退出</div></li></ol></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div><br/></div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>行情</div></td><td style="width: 130px; padding: 8px; border: 1px solid;">K线计算处理</td><td style="width: 763px; padding: 8px; border: 1px solid;"><ol><li><div><span style="font-size: 14px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(66, 66, 66); font-family: &quot;PingFang SC&quot;; font-variant-caps: normal; font-variant-ligatures: normal;">采用队列方式缓存，约可容纳30S的TICK缓存，占用一个处理线程用于存储MDB，500ms批量写入一次MDB</span></div></li><li><div><span style="font-size: 14px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(66, 66, 66); font-family: &quot;PingFang SC&quot;; font-variant-caps: normal; font-variant-ligatures: normal;">K线计算采用增量方式，计算前会对比交易线程的K线内存数据防止被病毒恶意篡改，计算完成后会将结果内存同步到交易线程，用于下一次计算比对</span></div></li><li><div><span style="font-size: 14px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(66, 66, 66); font-family: &quot;PingFang SC&quot;; font-variant-caps: normal; font-variant-ligatures: normal;">K线数据按分钟进行缓存天/时/分/结算价等K线数据，存储当然也包括计算过程中的增量数据，主要用于重新登录后重新加载MDB里最近一次的增量数据并延续计算时/天/结算</span></div></li><li><div><span style="font-size: 14px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(66, 66, 66); font-family: &quot;PingFang SC&quot;; font-variant-caps: normal; font-variant-ligatures: normal;">中金所按要求时间计算结算价，其他交易所结算价=全天VWAP</span></div></li><li><div><span style="font-size: 14px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(66, 66, 66); font-family: &quot;PingFang SC&quot;; font-variant-caps: normal; font-variant-ligatures: normal;">K线计算有数据范围检测，包括价格范围和浮点型范围，如果计算过程中出现范围检测失败则很有可能是TICK的价格为无效值导致的,TICK价格异常则直接丢弃，增量计算和异常则将数据初始化为0，这种情况一般出现在刚登录时刻或开盘第一个</span></div></li><li><div><span style="font-size: 14px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(66, 66, 66); font-family: &quot;PingFang SC&quot;; font-variant-caps: normal; font-variant-ligatures: normal;">K线计算也会进行量差检测，报错关键字：KV!</span></div></li><li><div><span style="font-size: 14px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(66, 66, 66); font-family: &quot;PingFang SC&quot;; font-variant-caps: normal; font-variant-ligatures: normal;">K线计算前对TICK价格检测，报错key：KP!</span></div></li><li><div><span style="font-size: 14px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(66, 66, 66); font-family: &quot;PingFang SC&quot;; font-variant-caps: normal; font-variant-ligatures: normal;">增量计算数据值的异常检测：报错key：KEYSUM!</span></div></li><li><div><span style="font-size: 14px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(66, 66, 66); font-family: &quot;PingFang SC&quot;; font-variant-caps: normal; font-variant-ligatures: normal;">增量数据对比异常：报错key：KCMP!</span></div></li><li><div><span style="font-size: 14px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(66, 66, 66); font-family: &quot;PingFang SC&quot;; font-variant-caps: normal; font-variant-ligatures: normal;">收盘后或者盘中超过十分钟没有收到最新TICK则自动将K线目前的计算结果PUSH到MDB，一分钟检查一次</span></div></li></ol></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div><br/></div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><span style="font-size: 14.6667px; color: rgb(66, 66, 66); font-family: &quot;PingFang SC&quot;;">行情</span></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>其他</div></td><td style="width: 763px; padding: 8px; border: 1px solid;"><ol><li><div><span style="font-size: 14px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(66, 66, 66); font-family: &quot;PingFang SC&quot;; font-variant-caps: normal; font-variant-ligatures: normal;">行情登录无需账号密码，但需要一个前置地址与通过交易接口查询到的合约信息用于定制行情</span></div></li><li><div><span style="font-size: 14px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(66, 66, 66); font-family: &quot;PingFang SC&quot;; font-variant-caps: normal; font-variant-ligatures: normal;">一般交易登录成功后才进行行情定制，如果碰到默认交易账户登录不上的情况将采用一个稳定的备用账号用于登录交易并获取相关的合约信息，当然备用账号也能够执行相关账号的TARGET交易</span></div></li></ol></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div><br/></div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>交易</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><span style="font-size: 11pt; color: rgb(66, 66, 66); font-family: &quot;PingFang SC&quot;;"> 初始化与登录</span></td><td style="width: 763px; padding: 8px; border: 1px solid;"><ol><li><div>分多个阶段：初始化句柄/配置/下单模板等相关参数-客户端认证-请求登录-投资者结算确认-查询合约信息-查询合约手续费-查询资金-查询各交易所报单-查询成交-查询持仓-启动订单生成/订单执行/定时处理/数据FALSH线程</div></li><li><div>不同登录阶段有不同的超时，最小为1S，超时后会重新尝试当前步骤，如果在某一阶段尝试失败次数超过5次则登录失败，软件会自动切换成备用账号登录</div></li></ol></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div><br/></div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>交易</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>TICK接收回调</div></td><td style="width: 763px; padding: 8px; border: 1px solid;"><ol><li><div>来自行情线程修正后的TICK将会被推送至交易线程队列</div></li><li><div>交易线程有合约状态处理，一般合约状态的刷新来自CTP-API（<span style="min-height: 11pt; font-size: 9.5pt; font-family: NSimSun;">OnRtnInstrumentStatus</span>）被动接收到的合约状态变更，盘中则通过连续4次TICK标记为盘中状态，确认同步上的提示为：#+合约，状态丢步：?+合约</div></li></ol></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div><br/></div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>交易</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>交易检查</div></td><td style="width: 763px; padding: 8px; border: 1px solid;"><ol><li><div>TICK驱动Algo生成订单推送到交易线程，交易线程处理下单与撤单</div></li><li><div>合约处于盘中或集中竞价状态才能产生订单与下单交易等</div></li><li><div>下单前会检查相关风控，详细见风控表行描述</div></li><li><div>检测到交易或前置掉线则不进行下单</div></li></ol></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div><br/></div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>交易</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>Algo线程/订单生成线程</div></td><td style="width: 763px; padding: 8px; border: 1px solid;"><ol><li><div>TICK驱动Algo生成订单，自动同步target到距离当前TICK时间最近的并且是已经过去的时间，过期的TARGET将会被丢弃</div></li><li><div>订单生成会检查订单管理和挂单</div></li><li><div>检查订单管理中是否有正在执行交易的订单，如果有正在执行交易的订单则不进行此次订单生成，主要是为了防止自成交</div></li><li><div>检查挂单，如果有超过3秒的挂单则进行撤单重开</div></li><li><div>TICK驱动检查挂单1分钟超时，在没有TARGET和没有需要生成订单的情况下，将检查挂单，超过1分钟未成交的挂单将会被撤单重开</div></li><li><div>订单生成是建立在持仓可用的基础上，通过获取挂单对消目前的持仓得到的持仓可用</div></li><li><div>集合竞价挂涨跌停价，连续竞价挂对价，撤单重开挂涨跌停，其他状态挂最新价，挂单价格异常则挂涨跌停</div></li><li><div>订单分割：中金所I品种类最大20手/单，中金T类最大50手/单，中金其他类50手/单，其他交易所产品最大200手/单</div></li><li><div> 订单生成时有风控检查最大持仓限制，超出持仓限制只能平仓不能继续开仓</div></li><li><div>订单生成规则为：优先平昨仓，其次开平今，平仓考虑挂单以及当前持仓可用</div></li><li><div>超时撤单重开的订单需要满足挂单时间大于3S以上，并且合约价格状态不处于涨跌停板，刚刚下的订单与涨跌停板的订单不进行撤单重开操作</div></li><li><div>订单生成考虑挂单对消后的持仓：<span style="min-height: 11pt; font-size: 9.5pt; color: rgb(163, 21, 21); font-family: NSimSun;">ID[合约ID] TARGET[目标数量] LNET[净持仓多头] LTD[今多可用] LYD[昨多可用] SNET[净持仓空头] STD[今空可用] SYD[昨空可用] OB[挂买开数] OS[挂卖开数] </span><span style="min-height: 11pt; font-size: 9.5pt; color: rgb(163, 21, 21); font-family: NSimSun;">VOL[订单委托数] REF[委托引用]</span></div></li><li><div><span style="font-size: 9pt; font-family: NSimSun;">TICK驱动</span><span style="font-size: 9pt; font-family: NSimSun;">交易</span><span style="font-size: 9pt; font-family: NSimSun;">，当然也结合了订单状态标志进行综合判断当前是否处于可交易时间段</span></div></li></ol></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div><br/></div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;">交易</td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>Flash线程/数据刷新线程</div></td><td style="width: 763px; padding: 8px; border: 1px solid;"><ol><li><div>频率为1S一次检查队列是否有数据需要保存到MDB，包括持仓/委托回报/成交回报/本地订单/HTS订单延迟统计等</div></li><li><div>持仓数据存储与维护与CTP持仓保持一致，存储到MDB时会按要求转换计算</div></li><li><div>根据成交回报进行任务进度统计与刷新</div></li></ol></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div><br/></div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>交易</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>Timer线程/定时任务线程</div></td><td style="width: 763px; padding: 8px; border: 1px solid;"><ol><li><div>定时任务时间分片为10S</div></li><li><div>10S检查一次是否掉线与重新登录</div></li><li><div>30S进行一次查询资金与统计盈亏</div></li><li><div>10S检查一次是否需要主动查询最新行情，集合竞价时刻用到此功能</div></li><li><div>10S刷新获取一次TARGET，如果检测到相关账户的TARGET的时间缀有变更则获取同步最新的TARGET</div></li><li><div>10S检查同步一次风控相关的控制参数</div></li><li><div>30S更新一次TARGET进度到MDB</div></li><li><div>10S进行一次持仓同步，在订单生成时检查成交持仓与委托持仓，如果不一致则丢掉当次TARGET生成并进行持仓同步，按交易所查询委托，按合约查询成交</div></li></ol></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div><br/></div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>交易</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>Trading线程/交易执行线程</div></td><td style="width: 763px; padding: 8px; border: 1px solid;"><ol><li><div>交易执行前会进行CTP登录状态检查，风控检查，风控检查详细见下N行描述</div></li><li><div>订单执行失败则会将该笔订单从挂单管理中删除</div></li><li><div>挂单管理主要管理正在交易中的订单，订单管理主要管理报单成功的订单，挂单管理会删除下单失败的/成交的/被撤销的订单，订单管理则会保留所有的订单</div></li><li><div>撤单执行不会进行风控检查</div></li><li><div>撤单成功后会立即进行撤单重开，重开的订单价格会使用涨跌停板价格，如果涨跌停被撤则使用涨跌停减一变动价</div></li><li><div>没有行情源则撤单不会主动获取行情也不会进行重开，没有行情源情况一般属于收盘后</div></li></ol></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div><br/></div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>交易</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>持仓更新与同步</div></td><td style="width: 763px; padding: 8px; border: 1px solid;"><ol><li><div>委托回报维护对应委托持仓，在委托状态标志为全部成交后进行维护委托持仓，</div></li><li><div>成交回报维护对应成交持仓，每笔成交回报都会进行维护成交持仓</div></li><li><div>订单生成前会进行委托持仓与成交持仓的对比，不一致则丢掉当次订单生成操作并进行持仓同步</div></li><li><div>已经参与维护的回报则不会再用作于二次维护</div></li><li><div>持仓更新与存储的格式规则同CTP一致，每次存储时则会按要求进行转换</div></li><li><div>在有成交的情况下才会刷新持仓</div></li></ol></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div><br/></div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>交易</div></td><td style="width: 130px; padding: 8px; border: 1px solid;">其他更新与同步</td><td style="width: 763px; padding: 8px; border: 1px solid;"><ol><li><div>资金PNL计算采用增量方式，具体为在成交回报时刻计算增量SUM和，在资金查询时刻再使用最新价进行浮动盈亏计算</div></li><li><div>昨仓PNL计算在登录时刻被计算了相关的增量SUM和</div></li><li><div>集合竞价采用网络补偿时钟驱动的方式进行订单生成，1S检查一次是否处于集合竞价时间（区分中金与普通交易所），然后判断合约状态，检查是否有行情价格参考源，如果合约不在集合竞价状态则不进行集合竞价，如果没有行情源则通知查询最新行情</div></li><li><div>集合竞价状态只能是通过CTP接口状态通知进行维护，连续交易状态可以通过连续4次TICK进行状态同步，所以需要注意的是软件一定要在CTP推送集合竞价状态标志前完成登录初始化，否则将会把所有合约判定在未知状态导致不会进行集合竞价报单，另外刚登录时前面4个TICK也将不会被用于触发交易，这将可能会影响开盘时刻的前3秒不会产生订单</div></li><li><div>CTP掉线会重新登录，在掉线状态下则不会进行交易，盘中进行持仓同步-订单与成交查询事务时连续两次超时/下单严重超时也将会导致软件认定CTP超时无响应，软件会进行重新登录操作</div></li><li><div>用于时间修正交易日获取有两个来源：一个是SHFE上期所/DCE大商所TICK行情数据里的交易日字段，一个是软件登录时的交易日字段</div></li><li><div>手续费查询接口返回的只有当前持仓的合约相关的手续费信息</div></li></ol></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div><br/></div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>风控</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>合约风控功能与计数</div></td><td style="width: 763px; padding: 8px; border: 1px solid;"><ol><li><div>风控有三部分：全局控制ENABLE，合约级控制CTRL，限制LIMIT与计数（MDB_TASK合约级存放的风控计数）</div></li><li><div>全局控制功能有：风控全局总开关，行情快照，K线快照，委托快照，成交快照，持仓快照，行情开关，交易开关</div></li><li><div>合约级控制是按合约进行相关控制的：跟踪品种交易信息<span style="min-height: 11pt; font-size: 9.5pt; font-family: NSimSun;">bFollow，禁止开仓</span><span style="min-height: 11pt; font-size: 9.5pt; font-family: NSimSun;">bStopOpen，禁止交易</span><span style="min-height: 11pt; font-size: 9.5pt; font-family: NSimSun;">bStopTrading</span></div></li><li><div><span style="font-size: 12px; font-family: NSimSun;">计数就是对相关动作进行计数，限制就是对所有合约的相关风控计数进行检查，检查不通过则禁止交易或订单生成</span></div></li><li><div><span style="font-size: 12px; font-family: NSimSun;">限制参数包括：</span><span style="min-height: 11pt; font-size: 9.5pt; color: rgb(0, 128, 0); font-family: NSimSun;">累计挂单数量</span><span style="min-height: 11pt; font-size: 9.5pt; font-family: NSimSun;">nOrderDaySum，</span><span style="min-height: 11pt; font-size: 9.5pt; color: rgb(0, 128, 0); font-family: NSimSun;">累计撤单数量</span><span style="min-height: 11pt; font-size: 9.5pt; font-family: NSimSun;">nCancelDaySum，</span><span style="min-height: 11pt; font-size: 9.5pt; color: rgb(0, 128, 0); font-family: NSimSun;">累计分钟委托数量</span><span style="min-height: 11pt; font-size: 9.5pt; font-family: NSimSun;">nOrderMinSum，</span><span style="min-height: 11pt; font-size: 9.5pt; color: rgb(0, 128, 0); font-family: NSimSun;">单笔报单最大数量</span><span style="min-height: 11pt; font-size: 9.5pt; font-family: NSimSun;">nOrderVolMax，</span><span style="min-height: 11pt; font-size: 9.5pt; color: rgb(0, 128, 0); font-family: NSimSun;">多头最大持仓</span><span style="min-height: 11pt; font-size: 9.5pt; font-family: NSimSun;">nLongPosMax，</span><span style="min-height: 11pt; font-size: 9.5pt; color: rgb(0, 128, 0); font-family: NSimSun;">空头最大持仓</span><span style="min-height: 11pt; font-size: 9.5pt; font-family: NSimSun;">nShortPosMax</span></div></li><li><div><span style="font-size: 12px; font-family: NSimSun;">计数参数：</span><span style="min-height: 11pt; font-size: 9.5pt; color: rgb(0, 128, 0); font-family: NSimSun;">该交易日需要交易的手数</span><span style="min-height: 11pt; font-size: 9.5pt; font-family: NSimSun;">lnDayNeedDo，</span><span style="min-height: 11pt; font-size: 9.5pt; color: rgb(0, 128, 0); font-family: NSimSun;">该时间点需要完成的手数</span><span style="min-height: 11pt; font-size: 9.5pt; font-family: NSimSun;">lnTimeNeedDo，</span><span style="min-height: 11pt; font-size: 9.5pt; color: rgb(0, 128, 0); font-family: NSimSun;">该时间点已完成的手数</span><span style="min-height: 11pt; font-size: 9.5pt; font-family: NSimSun;">lnTimeDone，</span><span style="min-height: 11pt; font-size: 9.5pt; color: rgb(0, 128, 0); font-family: NSimSun;">累计撤单次数</span><span style="min-height: 11pt; font-size: 9.5pt; font-family: NSimSun;">lnCancelNum，</span><span style="min-height: 11pt; font-size: 9.5pt; color: rgb(0, 128, 0); font-family: NSimSun;">累计发单次数</span><span style="min-height: 11pt; font-size: 9.5pt; font-family: NSimSun;">lnOrderNum，</span><span style="min-height: 11pt; font-size: 9.5pt; color: rgb(0, 128, 0); font-family: NSimSun;">最大下单量</span><span style="min-height: 11pt; font-size: 9.5pt; font-family: NSimSun;">lnMaxVolume，</span><span style="min-height: 11pt; font-size: 9.5pt; color: rgb(0, 128, 0); font-family: NSimSun;">最大持仓量</span><span style="min-height: 11pt; font-size: 9.5pt; font-family: NSimSun;">lnMaxPosition，</span><span style="min-height: 11pt; font-size: 9.5pt; color: rgb(0, 128, 0); font-family: NSimSun;">1分钟频率下单次数</span><span style="min-height: 11pt; font-size: 9.5pt; font-family: NSimSun;">lnOrderFreqMin</span></div></li><li><div><span style="color: rgb(28, 51, 135);">风控检查包括：报单价格</span><span style="min-height: 11pt; font-size: 9.5pt; color: rgb(28, 51, 135); font-family: NSimSun;">LimitPrice，是否被停止交易</span><span style="min-height: 11pt; font-size: 9.5pt; color: rgb(28, 51, 135); font-family: NSimSun;">bStopTrading，是否被停止开仓</span><span style="min-height: 11pt; font-size: 9.5pt; color: rgb(28, 51, 135); font-family: NSimSun;">bStopOpen，分钟委托数量限制</span><span style="min-height: 11pt; font-size: 9.5pt; color: rgb(28, 51, 135); font-family: NSimSun;">nOrderMinSum，撤单次数限制</span><span style="min-height: 11pt; font-size: 9.5pt; color: rgb(28, 51, 135); font-family: NSimSun;">nCancelDaySum，日间委托数量限制</span><span style="min-height: 11pt; font-size: 9.5pt; color: rgb(28, 51, 135); font-family: NSimSun;">nOrderDaySum，单笔最大委托数量限制</span><span style="min-height: 11pt; font-size: 9.5pt; color: rgb(28, 51, 135); font-family: NSimSun;">nOrderVolMax等</span></div></li><li><div><span style="font-size: 12px; font-family: NSimSun;">风控控制参数在交易模块的定时任务线程中进行刷新</span></div></li></ol></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div><br/></div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>风控</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>系统进程计数风控</div></td><td style="width: 763px; padding: 8px; border: 1px solid;"><ol><li><div>主要用于监控进程的状态，包括的项目有：</div></li></ol><div style="min-height: 11pt; text-align: left;"><span style="min-height: 11pt; font-size: 9.5pt; font-family: NSimSun;">       </span><span style="min-height: 11pt; font-size: 9.5pt; color: rgb(47, 79, 79); font-family: NSimSun;">RSC_INIT</span> <span style="min-height: 11pt; font-size: 9.5pt; font-family: NSimSun;">= 0,</span> <span style="min-height: 11pt; font-size: 9.5pt; color: rgb(0, 128, 0); font-family: NSimSun;">//初始化次数</span></div><div style="min-height: 11pt; text-align: left;"><span style="min-height: 11pt; font-size: 9.5pt; font-family: NSimSun;">       </span><span style="min-height: 11pt; font-size: 9.5pt; color: rgb(47, 79, 79); font-family: NSimSun;">RSC_LOGIN</span><span style="min-height: 11pt; font-size: 9.5pt; font-family: NSimSun;">,</span> <span style="min-height: 11pt; font-size: 9.5pt; color: rgb(0, 128, 0); font-family: NSimSun;">//登录次数</span></div><div style="min-height: 11pt; text-align: left;"><span style="min-height: 11pt; font-size: 9.5pt; font-family: NSimSun;">       </span><span style="min-height: 11pt; font-size: 9.5pt; color: rgb(47, 79, 79); font-family: NSimSun;">RSC_ORDFAIL</span><span style="min-height: 11pt; font-size: 9.5pt; font-family: NSimSun;">,</span> <span style="min-height: 11pt; font-size: 9.5pt; color: rgb(0, 128, 0); font-family: NSimSun;">//总下单出错次数</span></div><div style="min-height: 11pt; text-align: left;"><span style="min-height: 11pt; font-size: 9.5pt; font-family: NSimSun;">       </span><span style="min-height: 11pt; font-size: 9.5pt; color: rgb(47, 79, 79); font-family: NSimSun;">RSC_VOLX</span><span style="min-height: 11pt; font-size: 9.5pt; font-family: NSimSun;">,</span> <span style="min-height: 11pt; font-size: 9.5pt; color: rgb(0, 128, 0); font-family: NSimSun;">//量差异常次数</span></div><div style="min-height: 11pt; text-align: left;"><span style="min-height: 11pt; font-size: 9.5pt; font-family: NSimSun;">       </span><span style="min-height: 11pt; font-size: 9.5pt; color: rgb(47, 79, 79); font-family: NSimSun;">RSC_SYN_LINEK</span><span style="min-height: 11pt; font-size: 9.5pt; font-family: NSimSun;">,</span> <span style="min-height: 11pt; font-size: 9.5pt; color: rgb(0, 128, 0); font-family: NSimSun;">//读取加载K线次数</span></div><ol start="2"><li><div style="min-height: 11pt; text-align: left;">检测到异常后配合运行脚本进行进程重启</div></li><li><div style="min-height: 11pt; text-align: left;">该功能主要针对于后续维护代码所产生的各种异常</div></li></ol><div style="min-height: 11pt; text-align: left;"><span style="min-height: 11pt; font-size: 9.5pt;"><br/></span></div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div><br/></div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>MONGO</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>MDB存储</div></td><td style="width: 763px; padding: 8px; border: 1px solid;"><ol><li><div>MDB存储包括来自行情的TICK与K线数据，交易线程在交易过程中的产生的订单/成交/持仓/资金/任务进度等信息，也接受来自风控线程的逻辑控制，包括快照功能开关，跟随功能开关</div></li><li><div>MDB优化主要分两大块：采用MDB线程池的方式创建句柄，采用定时队列与批量任务BULK读写</div></li><li><div>线程池方式创建：配置JSON文件中定义的minPoolSize=8&amp;maxPoolSize=28，也就是设置可在表级的层面进行并发访问的线程数</div></li><li><div>定时队列与BULK读写：主要是优化应对行情的TICK与K线的频繁读写，但会对原有的读写造成一定的延迟，其中TICK存储为100MS进行一次BULK读写与更新，K线读写为500MS进行一次读写与更新</div></li><li><div>MDB部分数据加载功能包括：K线增量数据加载，风控控制参数与计数加载，TARGET加载与更新，用于支持定时更新和重启之后的延续计算</div></li><li><div><br/></div></li></ol></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div><br/></div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>MONGO</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>解析ALGO</div></td><td style="width: 763px; padding: 8px; border: 1px solid;"><ol><li><div> ALGO解析时间支持到毫秒级，所以freq系数需要改大于100MS，一般默认为1000MS，以防生成过多的TARGET</div></li><li><div><span style="color: rgb(227, 0, 0);">ALGO生成时间序列依赖合约品种的交易时间，具体维护参考MDB_BASIC.TRADE_TIME_TBL，请务必维护好该表，否则可能导致ALGO解析不了报错</span></div></li><li><div>ALGO解析有对量的算法参数支持：<span style="min-height: 11pt; font-size: 9.5pt; color: rgb(163, 21, 21); font-family: NSimSun;">VolK、</span><span style="min-height: 11pt; font-size: 9.5pt; color: rgb(163, 21, 21); font-family: NSimSun;">VolPowK</span></div></li><li><div><span style="font-size: 9pt;">ALGO 继承原来的5种模式，对日内实时选择用twapK模式</span></div></li><li><div><span style="font-size: 9pt;">ALGO 生成TARGET后会将计划回写到和交易计划在同一个表TARGET_PLAN,如果持仓量变化一直不变则最快10S一个目标量相同的TARGET，用于盘中定时检查量与稳定同步同时也避免时间节点过于密集导致没必要的内存开销</span></div></li><li><div>有TARGET目标量越界检测限制</div></li><li><div>ALGO生成依赖内存的实时净持仓，这样生成的TARGET可以避免在初始交易节点时的下单量尖而导致被风控，所以ALGO计划里的lastQty字段不参与解析到目标持仓</div></li><li><div>任意合约品种由于各种原因导致的生成TARGET失败将会影响该批次的所有合约的TARGET解析失败，也就是解析过程中任意的错误将会导致该TARGET_PLAN不会被生成和执行，相关的报错会按更新频率重复提示</div></li><li><div>ALGO解析生成的时间节点序列取决于当前时间与当前交易日</div></li></ol></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div><br/></div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>日志</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>LOG线程</div></td><td style="width: 763px; padding: 8px; border: 1px solid;"><ol><li><div>日志采用双队列与一个打印线程，线程200MS检查一次日志队列与输出</div></li><li><div>日志底层数据结构是采用分页的形式，双队列包括：APPEND附加日志与ONEPUSH独立日志</div></li><li><div>独立日志意味着每次打印之后必须分行，主要应对需要连续且明确独立输出的场合，比如记录事务，操作等</div></li><li><div>APPEND日志意味着写满当页之后才会输出，主要应对需要频繁且单次小量地输出，比如行情刷新[&gt;]，K线刷新[K]等</div></li><li><div>输出支持多种方式：输出到控制台/输出到日志文件夹txt/输出到MDB，预留网络打印</div></li><li><div>兼容支持UTF8中文与ASCII编码，接口使用时记得传入相关编码信息参数方面做转换，输出到MDB为UTF8编码，打印到控制台和日志存放为ASCII编码</div></li></ol></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div><br/></div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>系统</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>时钟与命令行</div></td><td style="width: 763px; padding: 8px; border: 1px solid;"><ol><li><div>时钟处理模块应对所有需要进行时间处理的场合，包括TICK时间修正，集合竞价触发等</div></li><li><div>时钟处理模块的核心为NTP网络时钟，默认4个NTP节点可选，一分钟获取同步一次网络时钟</div></li><li><div>网络实时时钟=获取到的网络时钟基数+本地系统毫秒计数偏移</div></li><li><div>交易所实时时钟=交易所最新TICK+PING网络延迟+固定偏移补偿</div></li><li><div>提供命令行查询功能，通过配置JSON文件导入命令行查询语句，10S执行一次命令行查询ping延迟</div></li><li><div>提供时间处理与转换功能CTimeCalc：TICK的UpdateTime转CTimeCalc，系统SYSTIME转CTimeCalc，长整形转CTimeCalc，CTimeCalc输出字符，CTimeCalc输出长整形，时钟变动上/下一秒/分/时/日，检测瑞平年</div></li><li><div>时钟修正参考来自网络时钟以及SHFE与DCE交易所的时钟，TICK超过网络时钟一个小时以上的认定为过期的TICK，将不会用作时间修正与被修正，过期/量差异常等不能被修正时间的TICK的TradeDay统一为-10101</div></li></ol></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div><br/></div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>配置与脚本运行</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>配置JSON</div></td><td style="width: 763px; padding: 8px; border: 1px solid;"><ol><li><div>主要涉及到位于软件根目录下的两个文件：RUN.bat，CONFIG.json</div></li><li><div>配置主要的参数有：用于交易登录的账号相关，用于连接的MDB连接字串，用于查延迟的CMD命令行</div></li><li><div>在软件启动时的最初时刻进行读取配置参数，采用共享指针传递给各线程使用，由于运行过程中只读，所以不必担心读写冲突</div></li><li><div>RUN.bat支持线程级自重启与windows任务定时启动，其中线程级自重启用于软件非交易时间的CTP接口异常退出，当然也会检查是否处于交易时间，不在交易时间则不会进行HTP软件自动重启任务，</div></li></ol></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div><br/></div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>TCP/HPTCP</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>TCP接口</div></td><td style="width: 763px; padding: 8px; border: 1px solid;"><ol><li><div>该TCP模块采用支持高并发功能的HPTCP库，队列自处理字节流与粘包</div></li><li><div>支持映射到PYTHON2.7与3.7的接口回调，包括PYTHON调用C++收发数据接口与C++回调PYTHON函数传递接收到的数据</div></li><li><div>用于支持快速行情查询，目前采用读MDB行情快照的方式获取最新行情</div></li></ol></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div><br/></div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>其他</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>其他</div></td><td style="width: 763px; padding: 8px; border: 1px solid;"><ol><li><div>采用自定义map，拥有8字节对齐与64位数据比较，比传统map在字符串处理上性能提升4倍</div></li><li><div>采用模板定义与预分配内存的环形队列，减少内存的频繁申请，采用原始指针提高处理效率，内存自封装与按页管理</div></li><li><div>编码转换提供UTF8-ASCII互转，UTF8-UNICODE互转</div></li><li><div>windows控制台窗口事件通知与修改标题，屏蔽</div></li><li><div>运行时刻接受键盘输入菜单，提供基本交互功能，部分交互功能完善中</div></li><li><div>自动化脚本有自动循环或退出机制，需要配合windows任务管理即可实现任务自动化运行</div></li><li><div>自动化脚本输出日志到软件根目录HTP_LOG.txt，具体程序异常可通过日志查看</div></li><li><div>为确保后续可能支持多平台，代码所用到的库基本上都包含跨平台封装，也有一小部分平台特性的接口调用，STL/BOOST/CTP/HPSOCKET/MONGODB基本都包含相关跨平台封装，后续移植到LINUX需要重新CMAKE编译对应平台的库与改动小部分平台特性代码就能够实现移植</div></li></ol></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div><br/></div></td></tr></tbody></table><div><br/></div></div><div><br/></div></span>
</div></body></html> 